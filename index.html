<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è·¨å¢ƒä¾›åº”é“¾æ§åˆ¶å° V2.5 - æ™ºèƒ½è¿­ä»£ç‰ˆ</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root {
        /* å“ç‰Œè‰²ï¼šç¿¡ç¿ ç»¿ */
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #d1fae5;
        --primary-gradient: linear-gradient(135deg, #34d399 0%, #10b981 50%, #059669 100%);
        --timeline-gradient: linear-gradient(90deg, #34d399, #3b82f6);

        /* ç•Œé¢ç°åº¦ */
        --bg-app: #f3f4f6;       /* æ•´ä½“èƒŒæ™¯ç° */
        --bg-panel: #ffffff;     /* å¡ç‰‡èƒŒæ™¯ç™½ */
        --text-main: #111827;    /* æ·±é»‘ */
        --text-sec: #6b7280;     /* æ¬¡çº§ç° */
        --border: #e5e7eb;

        /* é˜´å½±ä¸åœ†è§’ */
        --radius: 12px;
        --shadow-card: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; outline: none; }

    body {
        margin: 0;
        font-family: 'Inter', 'Microsoft YaHei', sans-serif;
        background-color: var(--bg-app);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
    }

    /* --- 1. å·¦ä¾§å¯¼èˆª (Sidebar) --- */
    aside {
        width: 240px;
        background: var(--bg-panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 20px;
        z-index: 10;
        flex-shrink: 0;
    }

    .brand {
        display: flex; align-items: center; gap: 10px;
        font-size: 1.2rem; font-weight: 800; color: var(--primary-dark);
        margin-bottom: 40px; padding-left: 10px;
    }
    .brand i { font-size: 1.5rem; color: var(--primary); }

    .nav-menu { list-style: none; padding: 0; margin: 0; }

    .nav-item {
        padding: 12px 15px; margin-bottom: 5px; border-radius: var(--radius);
        color: var(--text-sec); cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; gap: 12px; font-weight: 500;
    }
    .nav-item:hover { background: #f0fdf4; color: var(--primary-dark); }

    .nav-item.active {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
    }

    /* --- 2. ä¸»å†…å®¹åŒº (Main) --- */
    main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 0;
        position: relative;
    }

    header {
        background: var(--bg-panel);
        border-bottom: 1px solid var(--border);
        padding: 15px 30px;
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 5;
    }

    .page-title h2 { margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 10px;}
    .page-title p { margin: 2px 0 0 0; color: var(--text-sec); font-size: 0.85rem; }

    .hero-date-btn {
        background: white; border: 1px solid var(--primary); color: var(--primary);
        padding: 8px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;
        transition: 0.2s; display: flex; align-items: center; gap: 8px;
    }
    .hero-date-btn:hover { background: var(--primary-light); }

    .content-wrapper { padding: 30px; max-width: 1600px; margin: 0 auto; width: 100%; }

    .view-section { display: none; animation: fadeIn 0.4s ease; }
    .view-section.active { display: block; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* === è§†å›¾1: å·¥ä½œå°ç»„ä»¶ === */
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
        background: var(--bg-panel); padding: 20px; border-radius: var(--radius);
        box-shadow: var(--shadow-card); border-bottom: 3px solid transparent; transition: 0.3s;
    }
    .stat-card:hover { transform: translateY(-3px); border-bottom-color: var(--primary); }
    .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-top: 10px; font-variant-numeric: tabular-nums;}

    .filter-panel {
        background: var(--bg-panel); padding: 20px; border-radius: var(--radius);
        box-shadow: var(--shadow-card); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;
    }
    .input-clean {
        padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb; font-size: 0.9rem;
    }

    .btn-add-product {
        background: var(--primary-dark); color: white; border: none;
        padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;
        display: flex; align-items: center; gap: 8px; transition: 0.2s;
        box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
    }
    .btn-add-product:hover { background: var(--primary); transform: translateY(-2px); }

    .btn-search {
        background: white; color: var(--primary-dark); border: 1px solid var(--primary);
        padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 700;
        display: flex; align-items: center; gap: 8px; transition: 0.2s;
    }
    .btn-search:hover { background: var(--primary-light); }

    .table-container { background: var(--bg-panel); border-radius: var(--radius); box-shadow: var(--shadow-card); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f9fafb; padding: 15px; text-align: left; color: var(--text-sec); font-size: 0.8rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: top; }

    .ghost-input {
        width: 100%; border: 1px solid transparent; background: transparent;
        padding: 4px; font-size: 0.9rem; color: var(--text-main); border-radius: 4px;
        transition: 0.2s;
    }
    .ghost-input:hover, .ghost-input:focus { background: white; border-color: #d1d5db; }
    .text-bold { font-weight: 700; color: var(--primary-dark); font-size: 1rem; }
    .text-sm { font-size: 0.8rem; color: var(--text-sec); }

    .select-mini {
        padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border);
        font-size: 0.85rem; background: #fff; width: 100%;
        transition: 0.15s;
    }
    .remark-area {
        width: 100%; height: 60px; border: 1px solid var(--border); border-radius: 4px;
        padding: 5px; font-size: 0.85rem; resize: none; background: #f9fafb;
    }
    .remark-area:focus { background: white; border-color: var(--primary); }

    .sel-ok { border-color:#10b981 !important; color:#059669 !important; background:#ecfdf5 !important; }
    .sel-warn { border-color:#f59e0b !important; color:#d97706 !important; background:#fffbeb !important; }
    .sel-muted { border-color:#cbd5e1 !important; color:#64748b !important; background:#f8fafc !important; }
    .sel-blue { border-color:#3b82f6 !important; color:#1d4ed8 !important; background:#eff6ff !important; }

    .img-uploader {
        width:60px; height:60px;
        border-radius:6px;
        background:#f3f4f6;
        border:1px dashed #d1d5db;
        display:flex; align-items:center; justify-content:center;
        cursor:pointer;
        overflow:hidden;
        position:relative;
        transition: 0.2s;
    }
    .img-uploader:hover { border-color: var(--primary); background:#f0fdf4; }
    .img-uploader img {
        width:100%; height:100%;
        object-fit: cover;
        display:none;
    }
    .img-uploader .hint {
        font-size: 0.75rem;
        color:#9ca3af;
        display:flex; flex-direction:column; align-items:center; gap:4px;
    }

    .plan-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 15px;
    }
    .plan-item { display:flex; flex-direction:column; gap:4px; }
    .plan-item label { font-size:0.7rem; color:#6b7280; font-weight:600; white-space: nowrap;}
    .plan-item .mini-date {
        padding: 6px; border: 1px solid var(--border); border-radius: 6px;
        font-size: 0.8rem; color: var(--text-main); background: #fff;
        width: 100%;
    }
    .plan-item .mini-date:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16,185,129,0.1); }
    
    .span-col-2 { grid-column: span 2; }
    .mini-text-full {
        width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 6px;
        font-size: 0.8rem; background: #f9fafb;
    }

    .btn-row-del {
        background: transparent; color: #ef4444; border: 1px solid #fee2e2;
        width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .btn-row-del:hover { background: #fee2e2; transform: scale(1.1); }

    /* === è§†å›¾2: è¥é”€æ—¥å†ç»„ä»¶ === */
    .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .cal-month {
        background: white; padding: 20px; border-radius: var(--radius);
        box-shadow: var(--shadow-card); border: 1px solid transparent; transition: 0.3s;
        display: flex; flex-direction: column;
    }
    .cal-month:hover { border-color: var(--primary); transform: translateY(-3px); }
    .cal-month h3 { margin: 0 0 10px 0; color: var(--primary-dark); font-size: 1.1rem; border-bottom: 1px solid #f0fdf4; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
    .cal-month ul { padding-left: 20px; margin: 0; color: var(--text-sec); font-size: 0.9rem; flex: 1;}
    .cal-month li { margin-bottom: 6px; }
    .cal-active { background: #ecfdf5; border: 1px solid var(--primary); }

    /* === è§†å›¾3: å‘è´§è®¡åˆ’ === */
    .shipment-card {
        background: white; border-radius: 12px; box-shadow: var(--shadow-card);
        margin-bottom: 20px; padding: 20px; border: 1px solid var(--border); transition: 0.2s;
    }
    .shipment-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .shipment-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; padding-bottom: 15px; margin-bottom: 15px; }
    .sku-info { font-weight: bold; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .sku-badge { background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: var(--text-sec); font-weight: normal;}
    
    .status-wrapper { position: relative; }
    .status-select {
        appearance: none;
        padding: 8px 30px 8px 15px; border-radius: 20px; border: none;
        font-weight: 700; font-size: 0.85rem; cursor: pointer;
        outline: none; transition: 0.2s;
    }
    .st-pending { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }
    .st-transit { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .st-received { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
    
    .date-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .date-item { display: flex; flex-direction: column; gap: 5px; }
    .date-label { font-size: 0.75rem; color: var(--text-sec); font-weight: 600; }
    .date-input { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; width: 100%; background: #fafafa; }
    .remark-box { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; resize: vertical; min-height: 60px; font-size: 0.9rem; background: #fafafa; }

    .logistics-panel {
        margin-top: 15px;
        background: #fbfffd;
        border: 1px solid #e7f7ef;
        border-radius: 10px;
        padding: 15px;
    }
    .logistics-head {
        display:flex; align-items:center; justify-content:space-between; gap:10px;
        margin-bottom: 10px;
    }
    .logistics-head .title {
        font-weight: 800; color: var(--primary-dark);
        display:flex; align-items:center; gap:8px;
    }
    .btn-add-logistics {
        background: var(--primary-gradient);
        color:white; border:none; border-radius: 8px;
        padding: 8px 14px; cursor:pointer; font-weight:700;
        display:flex; align-items:center; gap:8px;
        box-shadow: 0 4px 6px rgba(16,185,129,0.2);
    }
    .btn-add-logistics:hover { filter: brightness(1.02); transform: translateY(-1px); }

    .log-row {
        display:grid;
        grid-template-columns: 1.2fr 1fr 1fr 40px;
        gap: 10px;
        align-items: end;
        padding: 10px 0;
        border-top: 1px dashed #e7f7ef;
    }
    .log-row:first-of-type { border-top: none; padding-top: 0; }
    .log-row .mini-label { font-size:0.75rem; color: var(--text-sec); font-weight: 700; }
    .log-row .mini-input {
        padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 0.9rem;
        width: 100%;
    }
    .btn-del {
        background: white; border: 1px solid #fee2e2; color: #ef4444;
        border-radius: 8px; cursor:pointer; height: 38px;
        display:flex; align-items:center; justify-content:center;
    }
    .btn-del:hover { background: #fff1f2; }

    .timeline {
        margin-top: 12px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
    }
    .timeline-top {
        display:flex; justify-content:space-between; align-items:center;
        font-size:0.8rem; color: var(--text-sec);
        margin-bottom: 10px;
    }
    .timeline-bar {
        position: relative;
        height: 12px;
        background: #eef2f7;
        border-radius: 999px;
        overflow: hidden;
    }
    .timeline-seg {
        position:absolute; top:0; height:100%;
        background: var(--timeline-gradient);
        border-radius: 999px;
        opacity: 1;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .timeline-markers {
        display:flex; justify-content:space-between;
        margin-top: 8px;
        font-size:0.75rem; color: var(--text-sec);
    }
    .tiny-note { font-size:0.8rem; color: var(--text-sec); margin-top: 8px; }

    /* === å¼¹çª— === */
    .modal-mask {
        position: fixed; inset: 0; background: rgba(17,24,39,0.45);
        display:none; align-items:center; justify-content:center; z-index: 999;
        padding: 20px;
    }
    .modal {
        width: min(560px, 100%);
        background: white; border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.18);
        overflow:hidden;
    }
    .modal-header {
        padding: 14px 18px;
        display:flex; align-items:center; justify-content:space-between;
        border-bottom: 1px solid var(--border);
        background: #fbfffd;
    }
    .modal-header .title { font-weight: 900; color: var(--primary-dark); display:flex; align-items:center; gap:10px; }
    .modal-close { cursor:pointer; color: #9ca3af; padding: 6px 10px; border-radius: 8px; }
    .modal-close:hover { background: #f3f4f6; color: #6b7280; }
    .modal-body { padding: 18px; }
    .form-grid {
        display:grid; grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .form-item { display:flex; flex-direction:column; gap:6px; }
    .form-item label { font-size:0.8rem; color: var(--text-sec); font-weight:700; }
    .form-item input, .form-item select, .form-item textarea {
        padding: 10px; border: 1px solid var(--border); border-radius: 10px; background:#f9fafb;
        font-size: 0.9rem;
    }
    .form-item textarea { grid-column: 1 / -1; resize: vertical; min-height: 70px; }
    .modal-footer {
        padding: 14px 18px;
        display:flex; justify-content:flex-end; gap: 10px;
        border-top: 1px solid var(--border);
        background: #fff;
    }
    .btn-ghost {
        background:white; color: var(--text-sec); border:1px solid var(--border);
        padding:10px 16px; border-radius: 10px; cursor:pointer; font-weight:700;
    }
    .btn-primary {
        background: var(--primary-gradient); color:white; border:none;
        padding:10px 18px; border-radius: 10px; cursor:pointer; font-weight:800;
        box-shadow: 0 6px 10px rgba(16,185,129,0.18);
    }
    .btn-primary:hover { filter: brightness(1.02); transform: translateY(-1px); }
    .err-tip { display:none; margin-top: 10px; color:#ef4444; font-size:0.85rem; font-weight:700; }

    /* â˜… è¿­ä»£ï¼šå³ä¸‹è§’æé†’å¼¹çª— */
    .notify-dock {
        position: fixed; bottom: 20px; right: 20px;
        width: 300px;
        background: white; border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border: 1px solid var(--border);
        z-index: 1000;
        display: flex; flex-direction: column;
        transition: 0.3s;
        overflow: hidden;
    }
    .notify-dock.minimized {
        height: 48px;
        width: 180px;
    }
    .notify-header {
        background: var(--primary-gradient);
        color: white; padding: 12px 15px;
        font-weight: 700; font-size: 0.9rem;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer;
    }
    .notify-body {
        max-height: 300px; overflow-y: auto;
        padding: 0; background: #fff;
    }
    .notify-item {
        padding: 12px 15px; border-bottom: 1px solid #f3f4f6;
        display: flex; gap: 10px; align-items: flex-start;
    }
    .notify-item:last-child { border-bottom: none; }
    .notify-item .icon { color: var(--primary); margin-top: 2px; }
    .notify-item .content { display: flex; flex-direction: column; gap: 2px; }
    .notify-item .title { font-size: 0.85rem; font-weight: 700; color: var(--text-main); }
    .notify-item .desc { font-size: 0.75rem; color: var(--text-sec); }
    .empty-notify { padding: 20px; text-align: center; color: #9ca3af; font-size: 0.85rem; }

</style>
</head>

<body>

<aside>
    <div class="brand">
        <i class="fas fa-layer-group"></i>
        <span>SupplyChain</span>
    </div>
    <ul class="nav-menu">
        <li class="nav-item active" onclick="switchTab('dashboard', this)">
            <i class="fas fa-tachometer-alt"></i> å·¥ä½œå°
        </li>
        <li class="nav-item" onclick="switchTab('marketing', this)">
            <i class="fas fa-calendar-alt"></i> è¥é”€æ—¥å†
        </li>
        <li class="nav-item" onclick="switchTab('shipments', this)">
            <i class="fas fa-shipping-fast"></i> å‘è´§è®¡åˆ’
        </li>
        <li class="nav-item" onclick="switchTab('settings', this)">
            <i class="fas fa-cog"></i> ç³»ç»Ÿè®¾ç½®
        </li>
    </ul>
</aside>

<main>
    <header>
        <div class="page-title">
            <h2 id="page-header-title">ä¾›åº”é“¾ååŒçœ‹æ¿</h2>
            <p id="page-header-desc">Integrated Supply Chain & Marketing Console</p>
        </div>
        <button class="hero-date-btn">
            <i class="far fa-clock"></i>
            <span id="top-date">Loading...</span>
        </button>
    </header>

    <div class="content-wrapper">

        <div id="view-dashboard" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:0.8rem;"><i class="fas fa-globe-asia"></i> åŒ—äº¬ (CN)</div>
                    <div class="stat-value" id="time-cn">--:--</div>
                </div>
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:0.8rem;"><i class="fas fa-flag-usa"></i> çº½çº¦ (US)</div>
                    <div class="stat-value" id="time-us">--:--</div>
                </div>
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:0.8rem;"><i class="fas fa-landmark"></i> ä¼¦æ•¦ (UK)</div>
                    <div class="stat-value" id="time-uk">--:--</div>
                </div>
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:0.8rem;"><i class="fas fa-euro-sign"></i> å·´é» (EU)</div>
                    <div class="stat-value" id="time-eu">--:--</div>
                </div>
            </div>

            <div class="filter-panel">
                <div>
                    <label style="font-size:0.8rem; color:#666;">SKUæœç´¢</label><br>
                    <input id="skuSearchInput" class="input-clean" placeholder="è¾“å…¥äº§å“ / SKU / ID...">
                </div>

                <div style="display:flex; flex-direction:column; gap:6px;">
                    <span style="font-size:0.8rem; color:#666;">æ“ä½œ</span>
                    <button id="btnSkuSearch" class="btn-search"><i class="fas fa-search"></i> æœç´¢</button>
                </div>

                <div style="margin-left:auto; display:flex; gap:10px;">
                    <button id="btnReset" style="background:white; color:var(--text-sec); border:1px solid var(--border); padding:10px 20px; border-radius:8px; cursor:pointer;">é‡ç½®</button>
                    <button class="btn-add-product" id="btnOpenAddProduct">
                        <i class="fas fa-plus"></i> æ–°å¢äº§å“
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="90">å›¾ç‰‡</th>
                            <th width="180">åŸºç¡€ä¿¡æ¯ (SKU/ID/åç§°)</th>
                            <th width="320">è®¡åˆ’ä¸è·Ÿè¿› (ä¸å‘è´§è®¡åˆ’è”åŠ¨)</th>
                            <th width="180">è¿è¥èŠ‚ç‚¹ / å€Ÿæ ·</th>
                            <th>å¾…è·Ÿè¿›äº‹é¡¹</th>
                            <th width="230">ä¾›åº”å•† / å¤‡æ³¨ / åˆ é™¤</th>
                        </tr>
                    </thead>

                    <tbody id="productTbody">
                        <tr data-row="product">
                            <td>
                                <div class="img-uploader" data-img-uploader>
                                    <img alt="preview">
                                    <div class="hint">
                                        <i class="fas fa-image"></i>
                                        <span>ä¸Šä¼ </span>
                                    </div>
                                    <input type="file" accept="image/*" style="display:none;">
                                </div>
                            </td>

                            <td>
                                <input class="ghost-input text-bold sku-field" value="SKU-2024-XP01" placeholder="SKU">
                                <input class="ghost-input text-sm id-field" value="ID: 882910" placeholder="IDç ">
                                <input class="ghost-input name-field" value="æˆ·å¤–é˜²æ°´è¿åŠ¨èƒŒåŒ…" placeholder="äº§å“åç§°">
                            </td>

                            <td>
                                <div class="plan-grid">
                                    <div class="plan-item">
                                        <label>è®¡åˆ’ä¸‹å•</label>
                                        <input type="date" class="mini-date plan-order" value="2024-03-01">
                                    </div>
                                    <div class="plan-item">
                                        <label>é¦–æ‰¹ä¸‹å•</label>
                                        <input type="date" class="mini-date plan-first-order" value="2024-02-01">
                                    </div>
                                    <div class="plan-item">
                                        <label>æ ·å“æ¥æ”¶</label>
                                        <input type="date" class="mini-date plan-sample" value="2024-02-15">
                                    </div>
                                    <div class="plan-item">
                                        <label>å›¾ç‰‡äº¤ä»˜</label>
                                        <input type="date" class="mini-date plan-img-delivery" value="2024-02-20">
                                    </div>
                                    <div class="plan-item">
                                        <label>å·¥å‚äº¤è´§</label>
                                        <input type="date" class="mini-date plan-factory" value="2024-03-10">
                                    </div>
                                    <div class="plan-item">
                                        <label>FBAåˆ°è´§</label>
                                        <input type="date" class="mini-date plan-arrival" value="">
                                    </div>
                                    <div class="plan-item span-col-2">
                                        <label>Listing çŠ¶æ€/é“¾æ¥</label>
                                        <input class="mini-text-full plan-listing" placeholder="å¦‚ï¼šå·²ä¸Šæ¶">
                                    </div>
                                    <div class="plan-item span-col-2">
                                        <label>ç‰©æµå‘è´§å•å· (Amz)</label>
                                        <input class="mini-text-full plan-amz-text" placeholder="å¦‚ï¼šFBA17XXX">
                                    </div>
                                </div>
                            </td>

                            <td>
                                <div style="display:flex; flex-direction:column; gap:8px;">
                                    <select class="select-mini solar-select">
                                        <option value="">é€‰æ‹©è¥é”€èŠ‚ç‚¹...</option>
                                        <option value="1">1æœˆ (New Year / æ¸…ä»“)</option>
                                        <option value="2">2æœˆ (Valentine / æ˜¥å­£)</option>
                                        <option value="3" selected>3æœˆ (Women's Day)</option>
                                        <option value="4">4æœˆ (Easter / å¤æ´»èŠ‚)</option>
                                        <option value="5">5æœˆ (Mother's Day)</option>
                                        <option value="6">6æœˆ (Father's Day)</option>
                                        <option value="7">7æœˆ (Prime Day)</option>
                                        <option value="8">8æœˆ (Back to School)</option>
                                        <option value="9">9æœˆ (Fall Season)</option>
                                        <option value="10">10æœˆ (Halloween / Q4)</option>
                                        <option value="11">11æœˆ (Black Friday / CM)</option>
                                        <option value="12">12æœˆ (Christmas)</option>
                                    </select>

                                    <select class="select-mini sample-select" data-color-mode="sample">
                                        <option value="yes" selected>âœ” å·²å€Ÿæ ·æ‹æ‘„</option>
                                        <option value="no">âœ˜ æœªå€Ÿæ ·</option>
                                    </select>

                                    <select class="select-mini onimg-select" data-color-mode="onimg">
                                        <option value="no" selected>âœ˜ æœªä¸Šå›¾</option>
                                        <option value="yes">âœ” å·²ä¸Šå›¾</option>
                                    </select>
                                </div>
                            </td>

                            <td>
                                <textarea class="remark-area" placeholder="åœ¨æ­¤è¾“å…¥å¾…è·Ÿè¿›å†…å®¹...">ç¡®è®¤äº”ç‚¹æè¿°ç¿»è¯‘ï¼›æ£€æŸ¥å¤–åŒ…è£…æ ‡ç­¾...</textarea>
                            </td>

                            <td>
                                <div style="display:flex; flex-direction:column; gap:8px;">
                                    <input class="mini-text-full supplier-field" placeholder="ä¾›åº”å•†ï¼ˆå·¥å‚/æ¸ é“ï¼‰">
                                    <textarea class="remark-area note-field" placeholder="å¤‡æ³¨ï¼ˆå¦‚ï¼šè´¦æœŸ/èµ·è®¢é‡ï¼‰"></textarea>
                                    <div style="display:flex; justify-content:flex-end;">
                                        <button class="btn-row-del" onclick="deleteProductRow(this)" title="åˆ é™¤æ­¤SKU"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>

                </table>
            </div>
        </div>

        <div id="view-marketing" class="view-section">
            <div class="calendar-grid" id="calendarGrid">
                </div>
        </div>

        <div id="view-shipments" class="view-section">
            <div id="shipmentsContainer"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div style="background:white; padding:40px; border-radius:12px; max-width: 600px; margin: 0 auto; box-shadow: var(--shadow-card);">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-top: 0;">ç³»ç»Ÿè®¾ç½®</h3>
                <div class="form-item">
                    <label>è¥é”€æ—¥å†è¯­è¨€ / Marketing Calendar Language</label>
                    <select class="select-mini" style="padding: 10px;" onchange="changeLang(this.value)">
                        <option value="cn" selected>ä¸­æ–‡ (Chinese)</option>
                        <option value="en">English (è‹±æ–‡)</option>
                    </select>
                </div>
            </div>
        </div>

    </div>
</main>

<div id="notification-dock" class="notify-dock">
    <div class="notify-header" onclick="toggleNotify()">
        <span>ğŸ”” ä»Šæ—¥æé†’ (<span id="notify-count">0</span>)</span>
        <i class="fas fa-chevron-down" id="notify-icon"></i>
    </div>
    <div class="notify-body" id="notify-list">
        </div>
</div>

<div class="modal-mask" id="addProductMask">
    <div class="modal">
        <div class="modal-header">
            <div class="title"><i class="fas fa-plus-circle"></i> æ–°å¢äº§å“</div>
            <div class="modal-close" onclick="closeAddProduct()"><i class="fas fa-times"></i></div>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-item">
                    <label>SKU</label>
                    <input id="apSku" placeholder="ä¾‹å¦‚ï¼šSKU-2026-XX01">
                </div>
                <div class="form-item">
                    <label>IDç </label>
                    <input id="apId" placeholder="ä¾‹å¦‚ï¼š882910">
                </div>
                <div class="form-item" style="grid-column:1/-1;">
                    <label>äº§å“åç§°</label>
                    <input id="apName" placeholder="ä¾‹å¦‚ï¼šæˆ·å¤–é˜²æ°´è¿åŠ¨èƒŒåŒ…">
                </div>
                <div class="form-item">
                    <label>è®¡åˆ’ä¸‹å•</label>
                    <input id="apPlan" type="date">
                </div>
                <div class="form-item">
                    <label>è¥é”€èŠ‚ç‚¹</label>
                    <select id="apSolar">
                        <option value="">é€‰æ‹©èŠ‚ç‚¹...</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>
                <div class="form-item" style="grid-column:1/-1;">
                    <label>å¾…è·Ÿè¿›äº‹é¡¹</label>
                    <textarea id="apRemark" placeholder="åœ¨æ­¤è¾“å…¥å¾…è·Ÿè¿›å†…å®¹..."></textarea>
                </div>
            </div>
            <div class="err-tip" id="apErr">è¯·å®Œå–„å¿…å¡«é¡¹ï¼šSKUã€IDç ã€äº§å“åç§°ã€‚</div>
        </div>
        <div class="modal-footer">
            <button class="btn-ghost" onclick="closeAddProduct()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="submitAddProduct()">ç¡®è®¤æ–°å¢</button>
        </div>
    </div>
</div>

<script>
    // è¥é”€æ—¥å†æ•°æ®
    const calendarData = {
        1: { cn: ["æ–°å¹´ç›®æ ‡", "å†¬å­£æ¸…ä»“", "æ˜¥å­£å¤‡è´§"], en: ["New Year Resolution", "Winter Clearance", "Spring Prep"] },
        2: { cn: ["æƒ…äººèŠ‚", "æ€»ç»Ÿæ—¥", "æ˜¥å­£æ–°å“"], en: ["Valentine's Day", "Presidents' Day", "Spring Collection"] },
        3: { cn: ["å¦‡å¥³èŠ‚", "åœ£å¸•ç‰¹é‡Œå…‹èŠ‚", "å¤æ´»èŠ‚å¤‡è´§"], en: ["Women's Day", "St. Patrick's Day", "Easter Preparation"] },
        4: { cn: ["å¤æ´»èŠ‚", "åœ°çƒæ—¥", "å¤å­£é€‰å“"], en: ["Easter / Spring Sale", "Earth Day", "Summer Sourcing"] },
        5: { cn: ["æ¯äº²èŠ‚", "é˜µäº¡å°†å£«çºªå¿µæ—¥", "å¤å­£å¤‡è´§"], en: ["Mother's Day", "Memorial Day", "Summer Stocking"] },
        6: { cn: ["çˆ¶äº²èŠ‚", "æ¯•ä¸šå­£", "Prime Day å†²åˆº"], en: ["Father's Day", "Graduation Season", "Prime Day Prep"] },
        7: { cn: ["Prime Day å¤§ä¿ƒ", "ç‹¬ç«‹æ—¥", "è¿”æ ¡å­£"], en: ["Prime Day Event", "Independence Day", "Back to School"] },
        8: { cn: ["è¿”æ ¡å­£é«˜å³°", "å¤å­£æ¸…ä»“", "ä¸‡åœ£èŠ‚å¤‡è´§"], en: ["Back to School Peak", "Summer Clearance", "Halloween Order"] },
        9: { cn: ["åŠ³åŠ¨èŠ‚", "ç§‹å­£æ–°å“", "Q4 ç‰©æµè®¡åˆ’"], en: ["Labor Day", "Fall Season Start", "Q4 Logistics Plan"] },
        10: { cn: ["ä¸‡åœ£èŠ‚", "æ„Ÿæ©èŠ‚å¤‡è´§", "èŠ‚æ—¥å‘è´§"], en: ["Halloween (31st)", "Thanksgiving Prep", "Holiday Shipping"] },
        11: { cn: ["é»‘äº”ç½‘ä¸€", "æ„Ÿæ©èŠ‚", "æ—ºå­£é”€å”®"], en: ["Black Friday & CM", "Thanksgiving", "Holiday Sales"] },
        12: { cn: ["åœ£è¯èŠ‚", "èŠ‚ç¤¼æ—¥", "å¹´ç»ˆå¤ç›˜"], en: ["Christmas", "Boxing Day", "Year End Review"] }
    };

    let currentLang = 'cn';

    function switchTab(viewName, clickedNav) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            item.style.background = "";
            item.style.color = "";
        });
        if (clickedNav) clickedNav.classList.add('active');

        document.querySelectorAll('.view-section').forEach(section => {
            section.classList.remove('active');
        });
        const targetId = 'view-' + viewName;
        document.getElementById(targetId).classList.add('active');

        const headerTitle = document.getElementById('page-header-title');
        if(viewName === 'dashboard') headerTitle.innerText = "ä¾›åº”é“¾ååŒçœ‹æ¿";
        else if(viewName === 'marketing') headerTitle.innerText = currentLang === 'cn' ? "è·¨å¢ƒè¥é”€æ—¥å†" : "Global Marketing Calendar";
        else if(viewName === 'shipments') headerTitle.innerText = "ç‰©æµå‘è´§è®¡åˆ’";
        else if(viewName === 'settings') headerTitle.innerText = "ç³»ç»Ÿè®¾ç½®";
    }

    function updateClock() {
        const now = new Date();
        const fmt = (tz) => now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });

        document.getElementById('time-cn').innerText = fmt('Asia/Shanghai');
        document.getElementById('time-us').innerText = fmt('America/New_York');
        document.getElementById('time-uk').innerText = fmt('Europe/London');
        document.getElementById('time-eu').innerText = fmt('Europe/Paris');
        document.getElementById('top-date').innerText = now.toLocaleDateString('zh-CN');
    }

    /* =========================
       SKU æœç´¢
       ========================= */
    function normalizeText(s) {
        return (s || '').toString().trim().toLowerCase();
    }

    function getRowSearchText(tr) {
        const sku = tr.querySelector('.sku-field')?.value || '';
        const id = tr.querySelector('.id-field')?.value || '';
        const name = tr.querySelector('.name-field')?.value || '';
        const supplier = tr.querySelector('.supplier-field')?.value || '';
        return normalizeText(`${sku} ${id} ${name} ${supplier}`);
    }

    function applySkuSearch() {
        const q = normalizeText(document.getElementById('skuSearchInput').value);
        const rows = document.querySelectorAll('#productTbody tr[data-row="product"]');

        rows.forEach(tr => {
            if (!q) { tr.style.display = ''; return; }
            const text = getRowSearchText(tr);
            tr.style.display = text.includes(q) ? '' : 'none';
        });
    }

    function resetAll() {
        document.getElementById('skuSearchInput').value = '';
        applySkuSearch();
        clearCalendarHighlightKeepCurrent();
    }

    /* =========================
       æ–°å¢äº§å“å¼¹çª—
       ========================= */
    function openAddProduct() {
        document.getElementById('addProductMask').style.display = 'flex';
        document.getElementById('apErr').style.display = 'none';
        document.getElementById('apErr').innerText = 'è¯·å®Œå–„å¿…å¡«é¡¹ï¼šSKUã€IDç ã€äº§å“åç§°ã€‚';
    }
    function closeAddProduct() {
        document.getElementById('addProductMask').style.display = 'none';
        document.getElementById('apErr').style.display = 'none';
        ['apSku','apId','apName','apPlan','apSolar','apRemark'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = '';
        });
    }

    function escapeHtml(str) {
        return (str || '').replace(/[&<>"']/g, function(m) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
    }

    function deleteProductRow(btn) {
        if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªSKUå—ï¼Ÿè¿™å°†åŒæ­¥ç§»é™¤å‘è´§è®¡åˆ’ã€‚")) return;
        const tr = btn.closest('tr');
        if(tr) {
            tr.remove();
            syncShipmentsFromProducts(); 
            checkReminders(); // æ›´æ–°æé†’
        }
    }

    function submitAddProduct() {
        const sku = document.getElementById('apSku').value.trim();
        const id = document.getElementById('apId').value.trim();
        const name = document.getElementById('apName').value.trim();
        const plan = document.getElementById('apPlan').value;
        const solar = document.getElementById('apSolar').value;
        const remark = document.getElementById('apRemark').value;

        if (!sku || !id || !name) {
            document.getElementById('apErr').style.display = 'block';
            return;
        }

        const existing = Array.from(document.querySelectorAll('.sku-field')).some(inp => normalizeText(inp.value) === normalizeText(sku));
        if (existing) {
            document.getElementById('apErr').innerText = 'æ–°å¢å¤±è´¥ï¼šSKU å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ SKUã€‚';
            document.getElementById('apErr').style.display = 'block';
            return;
        }

        const tr = document.createElement('tr');
        tr.setAttribute('data-row', 'product');
        tr.innerHTML = `
            <td>
                <div class="img-uploader" data-img-uploader>
                    <img alt="preview">
                    <div class="hint"><i class="fas fa-image"></i><span>ä¸Šä¼ </span></div>
                    <input type="file" accept="image/*" style="display:none;">
                </div>
            </td>
            <td>
                <input class="ghost-input text-bold sku-field" value="${escapeHtml(sku)}" placeholder="SKU">
                <input class="ghost-input text-sm id-field" value="ID: ${escapeHtml(id)}" placeholder="IDç ">
                <input class="ghost-input name-field" value="${escapeHtml(name)}" placeholder="äº§å“åç§°">
            </td>
            <td>
                <div class="plan-grid">
                    <div class="plan-item">
                        <label>è®¡åˆ’ä¸‹å•</label>
                        <input type="date" class="mini-date plan-order" value="${plan || ''}">
                    </div>
                    <div class="plan-item">
                        <label>é¦–æ‰¹ä¸‹å•</label>
                        <input type="date" class="mini-date plan-first-order">
                    </div>
                    <div class="plan-item">
                        <label>æ ·å“æ¥æ”¶</label>
                        <input type="date" class="mini-date plan-sample">
                    </div>
                    <div class="plan-item">
                        <label>å›¾ç‰‡äº¤ä»˜</label>
                        <input type="date" class="mini-date plan-img-delivery">
                    </div>
                    <div class="plan-item">
                        <label>å·¥å‚äº¤è´§</label>
                        <input type="date" class="mini-date plan-factory">
                    </div>
                    <div class="plan-item">
                        <label>FBAåˆ°è´§</label>
                        <input type="date" class="mini-date plan-arrival">
                    </div>
                    <div class="plan-item span-col-2">
                        <label>Listing çŠ¶æ€/é“¾æ¥</label>
                        <input class="mini-text-full plan-listing" placeholder="å¦‚ï¼šå·²ä¸Šæ¶">
                    </div>
                    <div class="plan-item span-col-2">
                        <label>ç‰©æµå‘è´§å•å· (Amz)</label>
                        <input class="mini-text-full plan-amz-text" placeholder="å¦‚ï¼šFBA17XXX">
                    </div>
                </div>
            </td>
            <td>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <select class="select-mini solar-select">
                        <option value="">é€‰æ‹©èŠ‚ç‚¹...</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                    <select class="select-mini sample-select" data-color-mode="sample">
                        <option value="no" selected>âœ˜ æœªå€Ÿæ ·</option>
                        <option value="yes">âœ” å·²å€Ÿæ ·æ‹æ‘„</option>
                    </select>
                    <select class="select-mini onimg-select" data-color-mode="onimg">
                        <option value="no" selected>âœ˜ æœªä¸Šå›¾</option>
                        <option value="yes">âœ” å·²ä¸Šå›¾</option>
                    </select>
                </div>
            </td>
            <td>
                <textarea class="remark-area" placeholder="åœ¨æ­¤è¾“å…¥å¾…è·Ÿè¿›å†…å®¹...">${escapeHtml(remark || '')}</textarea>
            </td>
            <td>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <input class="mini-text-full supplier-field" placeholder="ä¾›åº”å•†">
                    <textarea class="remark-area note-field" placeholder="å¤‡æ³¨"></textarea>
                    <div style="display:flex; justify-content:flex-end;">
                        <button class="btn-row-del" onclick="deleteProductRow(this)" title="åˆ é™¤æ­¤SKU"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </td>
        `;

        document.getElementById('productTbody').prepend(tr);

        const solarSel = tr.querySelector('.solar-select');
        if (solarSel && solar) solarSel.value = solar;

        bindSolarSelect(tr);
        bindImgUploaders(tr);
        bindColorSelects(tr);
        bindProductRowChange(tr);

        applySkuSearch();
        syncShipmentsFromProducts(); 
        checkReminders(); // åˆ·æ–°æé†’
        closeAddProduct();
    }

    /* =========================
       è¥é”€æ—¥å† & è¯­è¨€åˆ‡æ¢
       ========================= */
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const currentMonthIdx = new Date().getMonth();

        for(let i=1; i<=12; i++) {
            const mData = calendarData[i];
            const content = currentLang === 'cn' ? mData.cn : mData.en;
            const title = currentLang === 'cn' ? `${i}æœˆ` : `${i}æœˆ (${months[i-1]})`;
            const isActive = (i === currentMonthIdx + 1) ? 'cal-active' : '';
            const badge = isActive ? `<span style="font-size:0.7rem; background:var(--primary); color:white; padding:2px 6px; border-radius:4px;">Current</span>` : '';

            let lis = '';
            content.forEach(item => {
                // é«˜äº®å…³é”®å¤§ä¿ƒ
                if(item.includes("Prime") || item.includes("Black Friday") || item.includes("Halloween") || item.includes("Christmas") || item.includes("é»‘äº”") || item.includes("ä¸‡åœ£èŠ‚") || item.includes("åœ£è¯")) {
                    lis += `<li><strong style="color:#ea580c">${item}</strong></li>`;
                } else {
                    lis += `<li>${item}</li>`;
                }
            });

            const html = `
                <div class="cal-month ${isActive}" data-month="${i}">
                    <h3>${title} ${badge}</h3>
                    <ul>${lis}</ul>
                </div>
            `;
            grid.innerHTML += html;
        }
    }

    function clearCalendarHighlightKeepCurrent() {
        const months = document.querySelectorAll('#calendarGrid .cal-month');
        months.forEach(m => m.classList.remove('cal-active'));
        const currentMonthIdx = new Date().getMonth() + 1;
        const current = document.querySelector(`#calendarGrid .cal-month[data-month="${currentMonthIdx}"]`);
        if (current) current.classList.add('cal-active');
    }

    function highlightMarketingMonth(monthNumber, jumpToMarketing = false) {
        if (!monthNumber) return;
        clearCalendarHighlightKeepCurrent();
        const target = document.querySelector(`#calendarGrid .cal-month[data-month="${monthNumber}"]`);
        if (target) {
            target.classList.add('cal-active');
            if (jumpToMarketing) {
                const navMarketing = document.querySelector('.nav-item[onclick*="marketing"]');
                switchTab('marketing', navMarketing);
                setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'center' }), 60);
            }
        }
    }

    function bindSolarSelect(scopeEl) {
        const selects = scopeEl ? scopeEl.querySelectorAll('.solar-select') : document.querySelectorAll('.solar-select');
        selects.forEach(sel => {
            if (sel.__bound) return;
            sel.__bound = true;
            sel.addEventListener('change', (e) => {
                const val = e.target.value;
                const jump = e.shiftKey;
                highlightMarketingMonth(val, jump);
            });
            if (sel.value) highlightMarketingMonth(sel.value, false);
        });
    }

    function changeLang(lang) {
        currentLang = lang;
        renderCalendar();
    }

    /* =========================
       å›¾ç‰‡ & é¢œè‰²ç»„ä»¶
       ========================= */
    function bindImgUploaders(scopeEl) {
        const uploaders = scopeEl ? scopeEl.querySelectorAll('[data-img-uploader]') : document.querySelectorAll('[data-img-uploader]');
        uploaders.forEach(u => {
            if (u.__bound) return;
            u.__bound = true;
            const input = u.querySelector('input[type="file"]');
            const img = u.querySelector('img');
            const hint = u.querySelector('.hint');
            u.addEventListener('click', () => input && input.click());
            input.addEventListener('change', () => {
                const file = input.files && input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    if (hint) hint.style.display = 'none';
                };
                reader.readAsDataURL(file);
            });
        });
    }

    function applySelectColor(sel) {
        if (!sel) return;
        sel.classList.remove('sel-ok','sel-warn','sel-muted','sel-blue');
        const mode = sel.getAttribute('data-color-mode');
        const v = sel.value;
        if (mode === 'sample') {
            if (v === 'yes') sel.classList.add('sel-ok');
            else sel.classList.add('sel-warn');
        } else if (mode === 'onimg') {
            if (v === 'yes') sel.classList.add('sel-blue');
            else sel.classList.add('sel-muted');
        }
    }

    function bindColorSelects(scopeEl) {
        const sels = scopeEl ? scopeEl.querySelectorAll('[data-color-mode]') : document.querySelectorAll('[data-color-mode]');
        sels.forEach(sel => {
            if (sel.__bound) return;
            sel.__bound = true;
            sel.addEventListener('change', () => applySelectColor(sel));
            applySelectColor(sel); 
        });
    }

    /* =========================
       å‘è´§è®¡åˆ’é€»è¾‘ (å«è‡ªåŠ¨çŠ¶æ€)
       ========================= */
    function addDays(dateStr, days) {
        if (!dateStr) return '';
        const d = new Date(dateStr + 'T00:00:00');
        if (Number.isNaN(d.getTime())) return '';
        d.setDate(d.getDate() + (Number(days) || 0));
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr + 'T00:00:00');
        if (Number.isNaN(d.getTime())) return null;
        return d;
    }

    // â˜… è¿­ä»£ï¼šè‡ªåŠ¨åŒ–çŠ¶æ€åˆ¤æ–­
    function autoUpdateShipmentStatus(card) {
        const factoryDateStr = card.querySelector('.ship-factory')?.value;
        const amzDateStr = card.querySelector('.ship-amzDate')?.value;
        const fbaDateStr = card.querySelector('.fbaArrival')?.value;
        const statusSelect = card.querySelector('.status-select');

        if (!statusSelect) return;

        const today = new Date();
        today.setHours(0,0,0,0);

        let newStatus = 'pending';

        const dFactory = parseDate(factoryDateStr);
        const dAmz = parseDate(amzDateStr);
        const dFba = parseDate(fbaDateStr);

        // é€»è¾‘åˆ¤æ–­
        if (dFba && today >= dFba) {
            newStatus = 'received';
        } else if (dAmz && today >= dAmz) {
            newStatus = 'transit';
        } else if (dFactory && today < dFactory) {
            newStatus = 'pending';
        } else {
            // ä¸­é—´çŠ¶æ€ï¼ˆå¦‚å·²å‡ºå‚ä½†æœªç»™Amzå‘è´§ï¼‰ï¼Œé»˜è®¤ä¸ºå¾…å‘è´§æˆ–ç»´æŒåŸæ ·
            // è¿™é‡Œä¸ºäº†ç¬¦åˆé¢˜ç›®â€œæŠµè¾¾å‘è´§æ—¥æœŸåæ‰æ˜¾ç¤ºè¿è¾“ä¸­â€ï¼Œæˆ‘ä»¬ä¸åšé¢å¤–æ“ä½œï¼Œä¿æŒpendingå³å¯
        }

        // ä»…å½“çŠ¶æ€æ”¹å˜æ—¶æ›´æ–°ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©ï¼ˆå¦‚æœéœ€è¦æ”¯æŒæ‰‹åŠ¨è¦†ç›–ï¼‰
        // é¢˜ç›®è¦æ±‚è‡ªåŠ¨æ˜¾ç¤ºï¼Œå› æ­¤è¿™é‡Œå¼ºåˆ¶è¦†ç›–
        if (statusSelect.value !== newStatus) {
            statusSelect.value = newStatus;
            updateStatusStyle(statusSelect);
        }
    }

    function recalcLogistics(anyEl) {
        const card = anyEl.closest('.shipment-card');
        if (!card) return;

        const rows = card.querySelectorAll('[data-logrow]');
        let minDate = null;
        let maxDate = null;

        rows.forEach(r => {
            const ship = r.querySelector('.log-ship')?.value;
            const days = r.querySelector('.log-days')?.value;
            const arrive = addDays(ship, days);
            const arriveEl = r.querySelector('.log-arrive');
            if (arriveEl) arriveEl.value = arrive;

            const d1 = parseDate(ship);
            const d2 = parseDate(arrive);

            if (d1) minDate = (!minDate || d1 < minDate) ? d1 : minDate;
            if (d2) maxDate = (!maxDate || d2 > maxDate) ? d2 : maxDate;

            const fba = card.querySelector('.fbaArrival');
            if (fba && maxDate) {
                const yyyy = maxDate.getFullYear();
                const mm = String(maxDate.getMonth() + 1).padStart(2, '0');
                const dd = String(maxDate.getDate()).padStart(2, '0');
                fba.value = `${yyyy}-${mm}-${dd}`;
                // è§¦å‘åŒæ­¥æ›´æ–°çŠ¶æ€
                fba.dispatchEvent(new Event('input'));
            }
        });

        renderTimeline(card, minDate, maxDate);
        autoUpdateShipmentStatus(card);
    }

    function renderTimeline(card, startD, endD) {
        const bar = card.querySelector('[data-timeline] [data-bar]');
        const rangeText = card.querySelector('.timelineRangeText');
        const startText = card.querySelector('.timelineStartText');
        const endText = card.querySelector('.timelineEndText');
        const hint = card.querySelector('.timelineHint');
        if (!bar) return;

        bar.innerHTML = '';

        if (!startD || !endD || endD <= startD) {
            rangeText && (rangeText.innerText = '--');
            startText && (startText.innerText = '--');
            endText && (endText.innerText = '--');
            hint && (hint.innerText = 'æç¤ºï¼šè‹¥æ— æœ‰æ•ˆæ—¥æœŸï¼Œå°†ä¸æ˜¾ç¤ºåŒºé—´ã€‚');
            return;
        }

        const total = (endD - startD) / (1000 * 60 * 60 * 24);
        const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

        rangeText && (rangeText.innerText = `ç‰©æµå‘¨æœŸï¼š${Math.round(total)} å¤©`);
        startText && (startText.innerText = fmt(startD));
        endText && (endText.innerText = fmt(endD));
        hint && (hint.innerText = '');

        const rows = card.querySelectorAll('[data-logrow]');
        rows.forEach(r => {
            const ship = parseDate(r.querySelector('.log-ship')?.value);
            const arrive = parseDate(r.querySelector('.log-arrive')?.value);
            if (!ship || !arrive || arrive <= ship) return;

            const left = ((ship - startD) / (1000*60*60*24)) / total * 100;
            const width = ((arrive - ship) / (1000*60*60*24)) / total * 100;

            const seg = document.createElement('div');
            seg.className = 'timeline-seg';
            seg.style.left = `${Math.max(0, left)}%`;
            seg.style.width = `${Math.max(1, width)}%`;
            bar.appendChild(seg);
        });
    }

    function addLogisticsRow(btn) {
        const card = btn.closest('.shipment-card');
        const container = card.querySelector('[data-rows]');
        if (!container) return;

        const row = document.createElement('div');
        row.className = 'log-row';
        row.setAttribute('data-logrow', '');
        row.innerHTML = `
            <div class="form-item">
                <div class="mini-label">å‘è´§æ—¥æœŸ</div>
                <input type="date" class="mini-input log-ship" onchange="recalcLogistics(this)">
            </div>
            <div class="form-item">
                <div class="mini-label">åˆ°è´§æ—¶æ•ˆ (å¤©)</div>
                <input type="number" class="mini-input log-days" value="0" min="0" onchange="recalcLogistics(this)">
            </div>
            <div class="form-item">
                <div class="mini-label">åˆ°è´§æ—¥æœŸ (è‡ªåŠ¨)</div>
                <input type="date" class="mini-input log-arrive" readonly>
            </div>
            <button class="btn-del" title="åˆ é™¤" onclick="removeLogisticsRow(this)"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(row);
        recalcLogistics(row.querySelector('.log-days'));
    }

    function removeLogisticsRow(btn) {
        const card = btn.closest('.shipment-card');
        btn.closest('[data-logrow]')?.remove();
        const any = card.querySelector('.log-days') || card;
        recalcLogistics(any);
    }

    function updateStatusStyle(selectEl) {
        selectEl.classList.remove('st-pending', 'st-transit', 'st-received');
        const v = selectEl.value;
        if(v === 'pending') selectEl.classList.add('st-pending');
        else if(v === 'transit') selectEl.classList.add('st-transit');
        else if(v === 'received') selectEl.classList.add('st-received');
    }

    function buildShipmentCardHTML(sku, name) {
        return `
        <div class="shipment-card" data-shipment="${escapeHtml(sku)}">
            <div class="shipment-header">
                <div class="sku-info">
                    ${escapeHtml(sku)}
                    <span class="sku-badge">${escapeHtml(name || '')}</span>
                </div>
                <div class="status-wrapper">
                    <select class="status-select st-pending" onchange="updateStatusStyle(this)">
                        <option value="pending">â³ å¾…å‘è´§ (Pending)</option>
                        <option value="transit">âœˆ è¿è¾“ä¸­ (In Transit)</option>
                        <option value="received">âœ… å·²ç­¾æ”¶ (Received)</option>
                    </select>
                </div>
            </div>

            <div class="date-grid">
                <div class="date-item">
                    <span class="date-label">é¦–æ‰¹ä¸‹å•æ—¥æœŸ</span>
                    <input type="date" class="date-input ship-firstOrder">
                </div>
                <div class="date-item">
                    <span class="date-label">æ ·å“æ¥æ”¶æ—¥æœŸ</span>
                    <input type="date" class="date-input ship-sample">
                </div>
                <div class="date-item">
                    <span class="date-label">äº§å“ä¸»å›¾æ—¥æœŸ</span>
                    <input type="date" class="date-input ship-mainImg">
                </div>
                <div class="date-item">
                    <span class="date-label">äº¤è´§æœŸ (å·¥å‚)</span>
                    <input type="date" class="date-input ship-factory">
                </div>
                <div class="date-item">
                    <span class="date-label">Amazonå‘è´§æ—¥æœŸ</span>
                    <input type="date" class="date-input ship-amzDate">
                </div>
                <div class="date-item">
                    <span class="date-label">åˆ°è´§æœŸ (FBA)</span>
                    <input type="date" class="date-input fbaArrival">
                </div>
                <div class="date-item" style="grid-column: span 2">
                    <span class="date-label">Amazonå‘è´§ä¿¡æ¯</span>
                    <input class="date-input ship-amzText" placeholder="Shipment ID / ç‰©æµå•† / æ¸ é“">
                </div>
            </div>

            <div class="logistics-panel">
                <div class="logistics-head">
                    <div class="title"><i class="fas fa-route"></i> ç‰©æµå‘è´§è®¡åˆ’</div>
                    <button class="btn-add-logistics" onclick="addLogisticsRow(this)"><i class="fas fa-plus"></i> æ–°å¢ç‰©æµ</button>
                </div>

                <div class="logistics-rows" data-rows>
                    <div class="log-row" data-logrow>
                        <div class="form-item">
                            <div class="mini-label">å‘è´§æ—¥æœŸ</div>
                            <input type="date" class="mini-input log-ship" onchange="recalcLogistics(this)">
                        </div>
                        <div class="form-item">
                            <div class="mini-label">åˆ°è´§æ—¶æ•ˆ (å¤©)</div>
                            <input type="number" class="mini-input log-days" value="0" min="0" onchange="recalcLogistics(this)">
                        </div>
                        <div class="form-item">
                            <div class="mini-label">åˆ°è´§æ—¥æœŸ (è‡ªåŠ¨)</div>
                            <input type="date" class="mini-input log-arrive" readonly>
                        </div>
                        <button class="btn-del" title="åˆ é™¤" onclick="removeLogisticsRow(this)"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="timeline" data-timeline>
                    <div class="timeline-top">
                        <span><i class="fas fa-chart-gantt"></i> ç‰©æµå¯è§†åŒ–</span>
                        <span class="timelineRangeText">--</span>
                    </div>
                    <div class="timeline-bar" data-bar></div>
                    <div class="timeline-markers">
                        <span class="timelineStartText">--</span>
                        <span class="timelineEndText">--</span>
                    </div>
                    <div class="tiny-note timelineHint">æç¤ºï¼šè‹¥æ— æœ‰æ•ˆæ—¥æœŸï¼Œå°†ä¸æ˜¾ç¤ºåŒºé—´ã€‚</div>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <textarea class="remark-box" placeholder="åœ¨æ­¤è¾“å…¥å‘è´§å¤‡æ³¨..."></textarea>
            </div>
        </div>
        `;
    }

    function getProductsSnapshot() {
        const rows = document.querySelectorAll('#productTbody tr[data-row="product"]');
        return Array.from(rows).map(tr => {
            const sku = tr.querySelector('.sku-field')?.value || '';
            const name = tr.querySelector('.name-field')?.value || '';
            return { tr, sku: sku.trim(), name: name.trim() };
        }).filter(x => x.sku);
    }

    function syncShipmentsFromProducts() {
        const container = document.getElementById('shipmentsContainer');
        const products = getProductsSnapshot();

        const existingCards = Array.from(container.querySelectorAll('.shipment-card'));
        const existingSkuSet = new Set(existingCards.map(c => c.getAttribute('data-shipment')));

        products.forEach(p => {
            if (!existingSkuSet.has(p.sku)) {
                container.insertAdjacentHTML('beforeend', buildShipmentCardHTML(p.sku, p.name));
            } else {
                const card = container.querySelector(`.shipment-card[data-shipment="${CSS.escape(p.sku)}"]`);
                const badge = card?.querySelector('.sku-badge');
                if (badge) badge.innerText = p.name;
            }
        });

        existingCards.forEach(card => {
            const sku = card.getAttribute('data-shipment');
            if (!products.some(p => p.sku === sku)) card.remove();
        });

        container.querySelectorAll('.shipment-card').forEach(card => {
            const any = card.querySelector('.log-days');
            if (any && !card.__inited) {
                card.__inited = true;
                recalcLogistics(any);
            }
            // æ¯æ¬¡åŒæ­¥ä¹Ÿæ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            autoUpdateShipmentStatus(card);
        });

        products.forEach(p => {
            const card = container.querySelector(`.shipment-card[data-shipment="${CSS.escape(p.sku)}"]`);
            if (!card) return;

            const firstOrder = p.tr.querySelector('.plan-first-order')?.value || '';
            const sample = p.tr.querySelector('.plan-sample')?.value || '';
            const mainImg = p.tr.querySelector('.plan-img-delivery')?.value || '';
            const factory = p.tr.querySelector('.plan-factory')?.value || '';
            const arrival = p.tr.querySelector('.plan-arrival')?.value || '';
            const amzText = p.tr.querySelector('.plan-amz-text')?.value || '';

            const shipFirst = card.querySelector('.ship-firstOrder');
            const shipSample = card.querySelector('.ship-sample');
            const shipMain = card.querySelector('.ship-mainImg');
            const shipFactory = card.querySelector('.ship-factory');
            const fba = card.querySelector('.fbaArrival');
            const shipAmzText = card.querySelector('.ship-amzText');

            if (shipFirst && !shipFirst.value) shipFirst.value = firstOrder;
            if (shipSample && !shipSample.value) shipSample.value = sample;
            if (shipMain && !shipMain.value) shipMain.value = mainImg;
            if (shipFactory && !shipFactory.value) shipFactory.value = factory;
            if (fba && !fba.value) fba.value = arrival;
            if (shipAmzText && !shipAmzText.value) shipAmzText.value = amzText;

            const amzDate = card.querySelector('.ship-amzDate');
            const logShip = card.querySelector('.log-ship');
            if (amzDate && logShip && !logShip.value && amzDate.value) {
                logShip.value = amzDate.value;
                recalcLogistics(logShip);
            }

            // åŒæ­¥å®Œæ•°æ®åï¼Œå†æ¬¡è§¦å‘çŠ¶æ€æ£€æŸ¥
            autoUpdateShipmentStatus(card);
        });

        checkReminders(); // æ£€æŸ¥å¼¹çª—æé†’
    }

    // ç»‘å®šäº§å“è¡Œå†…æ‰€æœ‰è¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶è§¦å‘åŒæ­¥
    function bindProductRowChange(scopeEl) {
        const inputs = scopeEl.querySelectorAll('input, select');
        inputs.forEach(inp => {
            if (inp.__boundShipSync) return;
            inp.__boundShipSync = true;
            inp.addEventListener('input', () => syncShipmentsFromProducts());
            inp.addEventListener('change', () => syncShipmentsFromProducts());
        });
    }

    /* =========================
       â˜… è¿­ä»£ï¼šå³ä¸‹è§’å¼¹çª—æé†’é€»è¾‘
       ========================= */
    function toggleNotify() {
        const dock = document.getElementById('notification-dock');
        const icon = document.getElementById('notify-icon');
        dock.classList.toggle('minimized');
        if(dock.classList.contains('minimized')) {
            icon.className = 'fas fa-chevron-up';
        } else {
            icon.className = 'fas fa-chevron-down';
        }
    }

    function checkReminders() {
        const products = getProductsSnapshot();
        const listEl = document.getElementById('notify-list');
        const countEl = document.getElementById('notify-count');
        const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        let reminders = [];

        products.forEach(p => {
            const firstOrder = p.tr.querySelector('.plan-first-order')?.value;
            const mainImg = p.tr.querySelector('.plan-img-delivery')?.value;
            const arrival = p.tr.querySelector('.plan-arrival')?.value;

            if(firstOrder === todayStr) reminders.push({sku: p.sku, title: "é¦–æ‰¹ä¸‹å•æ—¥", date: firstOrder});
            if(mainImg === todayStr) reminders.push({sku: p.sku, title: "ä¸»å›¾äº¤ä»˜æ—¥", date: mainImg});
            if(arrival === todayStr) reminders.push({sku: p.sku, title: "FBAåˆ°è´§æ—¥", date: arrival});
        });

        listEl.innerHTML = '';
        countEl.innerText = reminders.length;

        if (reminders.length === 0) {
            listEl.innerHTML = '<div class="empty-notify">ä»Šæ—¥æš‚æ— å…³é”®èŠ‚ç‚¹</div>';
            return;
        }

        reminders.forEach(r => {
            const div = document.createElement('div');
            div.className = 'notify-item';
            div.innerHTML = `
                <div class="icon"><i class="fas fa-bell"></i></div>
                <div class="content">
                    <span class="title">${r.title}</span>
                    <span class="desc">${r.sku} - ä»Šæ—¥åˆ°è¾¾èŠ‚ç‚¹</span>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    window.onload = () => {
        updateClock();
        setInterval(updateClock, 1000);
        
        renderCalendar(); // åˆå§‹åŒ–æ—¥å†

        document.getElementById('btnSkuSearch').addEventListener('click', applySkuSearch);
        document.getElementById('skuSearchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') applySkuSearch();
        });

        document.getElementById('btnReset').addEventListener('click', resetAll);
        document.getElementById('btnOpenAddProduct').addEventListener('click', openAddProduct);

        bindSolarSelect(document);
        bindImgUploaders(document);
        bindColorSelects(document);

        document.querySelectorAll('#productTbody tr[data-row="product"]').forEach(tr => bindProductRowChange(tr));

        syncShipmentsFromProducts();

        document.getElementById('addProductMask').addEventListener('click', (e) => {
            if (e.target.id === 'addProductMask') closeAddProduct();
        });
    };
</script>

</body>
</html>